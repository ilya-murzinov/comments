version: 2
jobs:
  build:
    filters:
      branches:
        only: master
    working_directory: ~/hcomments
    machine:
      services:
        - docker
    steps:
      - checkout
      - restore_cache:
          key: hcomments-{{ checksum "hcomments.cabal" }}
      - run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 575159689BEFB442
          echo 'deb http://download.fpcomplete.com/ubuntu precise main'|sudo tee /etc/apt/sources.list.d/fpco.list
          sudo apt-get update && sudo apt-get install stack -y
      - run: |
          docker info
          stack setup
      - run: |
          make
          stack test
      - save_cache:
          paths:
            - ~/.stack
            - ~/.postgres-emedded
          key: hcomments-{{ checksum "hcomments.cabal" }}
          
  deploy:
    commands: |
      docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      make push

workflows:
  version: 2
  build:
    jobs:
      - build
  deploy:
    jobs:
      - build:
          filters:
            tags: /release-.*/
      - deploy
